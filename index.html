<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Match-3 Game</title>
  <style>
    body {
      margin: 0;
      background: #000;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      flex-direction: column;
      color: white;
      font-family: sans-serif;
    }
    #score {
      font-size: 24px;
      margin-bottom: 10px;
    }
    canvas {
      border: 4px solid white;
      /* Ensure canvas is displayed at its natural resolution */
      width: 448px;
      height: 640px;
    }
  </style>
</head>
<body>
  <div id="score">Score: 0</div>
  <canvas id="gameCanvas" width="448" height="640"></canvas>

  <script>
    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");
    const scoreDisplay = document.getElementById("score");

    const COLS = 7;
    const ROWS = 10;
    const TILE_SIZE = 64;

    const board = [];
    let selectedTile = null;
    let animatingTiles = [];
    let isAnimating = false;
    let score = 0;

    const background = new Image();
    background.src = "Background2.png";
    background.onload = () => requestAnimationFrame(gameLoop);

    function initBoard() {
      for (let y = 0; y < ROWS; y++) {
        board[y] = [];
        for (let x = 0; x < COLS; x++) {
          board[y][x] = Math.floor(Math.random() * 6);
        }
      }
    }
    initBoard();

    function gameLoop() {
      draw();
      if (isAnimating) updateAnimations();
      requestAnimationFrame(gameLoop);
    }

    function draw() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      if (background.complete) ctx.drawImage(background, 0, 0, canvas.width, canvas.height);

      for (let y = 0; y < ROWS; y++) {
        for (let x = 0; x < COLS; x++) {
          const idx = board[y][x];
          if (idx != null) {
            const img = document.getElementById(`tile${idx}`);
            if (img && img.complete) ctx.drawImage(img, x * TILE_SIZE, y * TILE_SIZE, TILE_SIZE, TILE_SIZE);
          }
          if (selectedTile && selectedTile.x === x && selectedTile.y === y) {
            ctx.strokeStyle = "yellow";
            ctx.lineWidth = 3;
            ctx.strokeRect(x * TILE_SIZE, y * TILE_SIZE, TILE_SIZE, TILE_SIZE);
          }
        }
      }
      scoreDisplay.textContent = `Score: ${score}`;
    }

    canvas.addEventListener("click", (e) => {
      if (isAnimating) return;
      const rect = canvas.getBoundingClientRect();
      const scaleX = canvas.width / rect.width;
      const scaleY = canvas.height / rect.height;
      const x = Math.floor((e.clientX - rect.left) * scaleX / TILE_SIZE);
      const y = Math.floor((e.clientY - rect.top) * scaleY / TILE_SIZE);

      console.log('Click coords raw:', e.clientX, e.clientY, '-> tile', x, y);
      if (x < 0 || x >= COLS || y < 0 || y >= ROWS) return;

      if (selectedTile) {
        const dx = Math.abs(selectedTile.x - x);
        const dy = Math.abs(selectedTile.y - y);
        if (dx + dy === 1) {
          swapTiles(selectedTile.x, selectedTile.y, x, y);
          const matches = checkMatches();
          if (matches.length) startAnimation(matches);
          selectedTile = null;
        } else {
          selectedTile = {x, y};
        }
      } else {
        selectedTile = {x, y};
      }
    });

    function swapTiles(x1, y1, x2, y2) {
      [board[y1][x1], board[y2][x2]] = [board[y2][x2], board[y1][x1]];
      draw();
    }
    
    function checkMatches() {
      const m = [];
      const seen = new Set();
      for (let y=0;y<ROWS;y++)for(let x=0;x<COLS-2;x++){
        const a=board[y][x],b=board[y][x+1],c=board[y][x+2];
        if(a!=null&&a===b&&b===c)for(let i=0;i<3;i++){const key=`${x+i},${y}`;if(!seen.has(key)){seen.add(key);m.push({x:x+i,y});}}
      }
      for (let x=0;x<COLS;x++)for(let y=0;y<ROWS-2;y++){
        const a=board[y][x],b=board[y+1][x],c=board[y+2][x];
        if(a!=null&&a===b&&b===c)for(let i=0;i<3;i++){const key=`${x},${y+i}`;if(!seen.has(key)){seen.add(key);m.push({x,y:y+i});}}
      }
      return m;
    }

    function startAnimation(matches) {
      animatingTiles = matches.map(p=>({...p,progress:0}));
      isAnimating = true;
    }

    function updateAnimations() {
      let done=true;
      animatingTiles.forEach(t=>{
        t.progress+=0.1;
        if(t.progress<1) done=false;
      });
      if(done){
        animatingTiles.forEach(({x,y})=>board[y][x]=null);
        score+=animatingTiles.length*10;
        animatingTiles=[];
        dropTiles();fillEmpty();
        const nm=checkMatches();
        if(nm.length) startAnimation(nm); else isAnimating=false;
      }
    }

    function dropTiles(){for(let x=0;x<COLS;x++)for(let y=ROWS-1;y>=0;y--){if(board[y][x]==null)for(let k=y-1;k>=0;k--)if(board[k][x]!=null){board[y][x]=board[k][x];board[k][x]=null;break;}}}
    function fillEmpty(){for(let y=0;y<ROWS;y++)for(let x=0;x<COLS;x++)if(board[y][x]==null)board[y][x]=Math.floor(Math.random()*6);}
  </script>

  <!-- Preload tile images with correct ids -->
  <img id="tile0" src="Bronze.png" style="display:none" />
  <img id="tile1" src="Bronze2.png" style="display:none" />
  <img id="tile2" src="Gold.png" style="display:none" />
  <img id="tile3" src="Gold2.png" style="display:none" />
  <img id="tile4" src="Platina.png" style="display:none" />
  <img id="tile5" src="Silver.png" style="display:none" />
</body>
</html>
