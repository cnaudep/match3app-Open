<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>Match-3 Game</title>
  <style>
    body { margin:0; background:#000; display:flex; justify-content:center; align-items:center; height:100vh; color:#fff; font-family:sans-serif; overflow:hidden; }
    #container { position:relative; }
    #menu, #endScreen { position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); display:flex; justify-content:center; align-items:center; flex-direction:column; z-index:10; }
    #menu button, #endScreen button { font-size:4vw; padding:2vw 4vw; margin-top:2vh; cursor:pointer; border:none; border-radius:1vw; background:#fff; color:#000; }
    #hud { position:absolute; top:1vh; left:50%; transform:translateX(-50%); display:flex; gap:5vw; font-size:4vw; z-index:5; }
    canvas { display:block; }
    #preloadImgs { display:none; }
  </style>
</head>
<body>
  <div id="container">
    <div id="menu">
      <h1 style="font-size:6vw; margin:0;">Match-3 Game</h1>
      <button id="startBtn">Старт уровня</button>
    </div>
    <div id="endScreen" style="display:none;">
      <h2 id="endMessage" style="font-size:6vw;">Игра окончена</h2>
      <div id="finalScore" style="font-size:5vw; margin-top:2vh;">Ваш счёт: 0</div>
      <button id="restartBtn">Начать заново</button>
    </div>
    <div id="hud" style="display:none;"></div>
    <canvas id="gameCanvas"></canvas>
  </div>

  <!-- Preload images -->
  <div id="preloadImgs">
    <img id="tile0" src="Bronze.png">
    <img id="tile1" src="Bronze2.png">
    <img id="tile2" src="Gold.png">
    <img id="tile3" src="Gold2.png">
    <img id="tile4" src="Platina.png">
    <img id="tile5" src="Silver.png">
    <img id="bg"    src="Background2.png">
  </div>

  <script>
  document.addEventListener("DOMContentLoaded",()=>{
    const menu       = document.getElementById('menu');
    const startBtn   = document.getElementById('startBtn');
    const endScreen  = document.getElementById('endScreen');
    const restartBtn = document.getElementById('restartBtn');
    const endMessage = document.getElementById('endMessage');
    const finalScore = document.getElementById('finalScore');
    const hud        = document.getElementById('hud');
    const canvas     = document.getElementById('gameCanvas');
    const ctx        = canvas.getContext('2d');

    const COLS=7, ROWS=10;
    let board, selected, score, moves, collected, target=15;
    let TILE, canvasWidth, canvasHeight;

    const tileImages = [];
    for(let i=0;i<6;i++) tileImages.push(document.getElementById('tile'+i));
    const bgImage=document.getElementById('bg');

    function resizeCanvas(){
      const vw = window.innerWidth;
      const vh = window.innerHeight;
      TILE = Math.floor(Math.min(vw/10, vh/12));
      canvasWidth = TILE*COLS;
      canvasHeight= TILE*ROWS;
      canvas.width = canvasWidth;
      canvas.height= canvasHeight;
      document.getElementById('container').style.width= canvasWidth+'px';
      document.getElementById('container').style.height= canvasHeight+'px';
      updateHUD();
      if(board) draw();
    }

    function updateHUD(){
      hud.innerHTML = `<div>Счёт: ${score}</div><div>Ходов: ${moves}</div><div>Gold2: ${collected}/${target}</div>`;
    }

    function initLevel(){
      board=[]; selected=null;
      score=0; moves=20; collected=0;
      updateHUD();
      for(let y=0;y<ROWS;y++){board[y]=[];for(let x=0;x<COLS;x++){board[y][x]=Math.floor(Math.random()*tileImages.length);}}
      draw();
      hud.style.display='flex'; menu.style.display='none'; endScreen.style.display='none';
    }

    function draw(){
      ctx.clearRect(0,0,canvasWidth,canvasHeight);
      ctx.drawImage(bgImage,0,0,canvasWidth,canvasHeight);
      for(let y=0;y<ROWS;y++) for(let x=0;x<COLS;x++){
        const idx=board[y][x]; if(idx==null)continue;
        ctx.drawImage(tileImages[idx],x*TILE,y*TILE,TILE,TILE);
        if(selected&&selected.x===x&&selected.y===y){ctx.strokeStyle='#fff';ctx.lineWidth=4;ctx.strokeRect(x*TILE,y*TILE,TILE,TILE);} }
    }

    canvas.addEventListener('click',e=>{
      if(moves<=0) return;
      const rect=canvas.getBoundingClientRect();
      const x=Math.floor((e.clientX-rect.left)/TILE),y=Math.floor((e.clientY-rect.top)/TILE);
      if(x<0||x>=COLS||y<0||y>=ROWS)return;
      if(selected){const dx=Math.abs(selected.x-x),dy=Math.abs(selected.y-y);
        if(dx+dy===1){swap(selected.x,selected.y,x,y);const m=findMatches();
          if(m.length){removeMatches(m);moves--;}
          else swap(selected.x,selected.y,x,y);
          selected=null;updateHUD();checkEnd();
        }else selected={x,y};
      }else selected={x,y};draw();
    });

    function swap(x1,y1,x2,y2){[board[y1][x1],board[y2][x2]]=[board[y2][x2],board[y1][x1]];}
    function findMatches(){const s=new Set();for(let y=0;y<ROWS;y++)for(let x=0;x<COLS-2;x++){const t=board[y][x];if(t!=null&&t===board[y][x+1]&&t===board[y][x+2])[[x,y],[x+1,y],[x+2,y]].forEach(p=>s.add(JSON.stringify(p)));}
      for(let x=0;x<COLS;x++)for(let y=0;y<ROWS-2;y++){const t=board[y][x];if(t!=null&&t===board[y+1][x]&&t===board[y+2][x])[[x,y],[x,y+1],[x,y+2]].forEach(p=>s.add(JSON.stringify(p)));}
      return Array.from(s).map(JSON.parse);
    }
    function removeMatches(m){m.forEach(([x,y])=>{if(board[y][x]===3)collected++;board[y][x]=null;score+=10;});collapse();refill();updateHUD();draw();setTimeout(()=>{const nm=findMatches();if(nm.length)removeMatches(nm);},200);}    
    function collapse(){for(let x=0;x<COLS;x++){const col=board.map(r=>r[x]).filter(v=>v!=null);while(col.length<ROWS)col.unshift(Math.floor(Math.random()*tileImages.length));col.forEach((v,y)=>board[y][x]=v);} }
    function refill(){for(let y=0;y<ROWS;y++)for(let x=0;x<COLS;x++)if(board[y][x]==null)board[y][x]=Math.floor(Math.random()*tileImages.length);}    
    function checkEnd(){if(collected>=target){endMessage.textContent='Уровень пройден';finalScore.textContent=`Ваш счёт: ${score}`;endScreen.style.display='flex';}
      else if(moves<=0){endMessage.textContent='Игра окончена';finalScore.textContent=`Ваш счёт: ${score}`;endScreen.style.display='flex';}}

    startBtn.addEventListener('click',initLevel);
    restartBtn.addEventListener('click',()=>{initLevel();});
    window.addEventListener('resize',resizeCanvas);
    resizeCanvas();
  });
  </script>
</body>
</html>
