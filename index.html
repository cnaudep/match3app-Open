<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <title>Match-3 Game</title>
    <style>
      body {
        margin: 0;
        background: #000;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        color: #fff;
        font-family: sans-serif;
        overflow: hidden;
        padding-bottom: 80px; /* фикс нижнего ряда */
      }
      #menu {
        position: fixed;
        inset: 0;
        display: flex;
        justify-content: center;
        align-items: center;
        background: url("Background2.png") center/cover no-repeat;
        z-index: 100;
      }
      #menu h1 {
        color: #fff;
        font-size: 32px;
        margin-bottom: 20px;
      }
      #menu button {
        font-size: 18px;
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        background: #fff;
        color: #000;
        cursor: pointer;
      }
      #hud {
        position: absolute;
        top: 10px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        justify-content: space-between;
        font-size: 18px;
        z-index: 50;
        padding: 0 10px;
        box-sizing: border-box;
        width: calc(64px * 7 + 8px * 2);
      }
      #hud > div {
        margin: 0 8px;
        white-space: nowrap;
      }
      canvas {
        border: 4px solid #fff;
        margin-top: 50px;
        box-sizing: border-box;
        width: 448px;
        height: 640px;
        touch-action: none;
      }
      @media (max-width: 600px) {
        canvas {
          width: calc(100vw - 20px);
          height: calc((100vw - 20px) * (640 / 448));
          margin-top: 60px;
          margin-bottom: 10px;
        }
        #hud {
          top: 10px;
          flex-wrap: wrap;
          justify-content: center;
          width: 100%;
          padding: 0;
          font-size: 14px;
        }
        #hud > div {
          margin: 4px 6px;
        }
      }
    </style>
  </head>
  <body>
    <!-- Меню -->
    <div id="menu">
      <div style="text-align: center">
        <h1>Match-3 Game</h1>
        <button id="startBtn">Старт</button>
      </div>
    </div>

    <!-- HUD -->
    <div id="hud" style="display: none">
      <div id="score">Счёт: 0</div>
      <div id="moves">Ходов: 20</div>
      <div id="goal">Gold2: 0/15</div>
    </div>

    <!-- Игровое поле -->
    <canvas id="gameCanvas" width="448" height="640"></canvas>

    <!-- Предзагрузка ресурсов -->
    <div id="preloadImgs" style="display: none">
      <img id="tile0" src="Bronze.png" />
      <img id="tile1" src="Bronze2.png" />
      <img id="tile2" src="Gold.png" />
      <img id="tile3" src="Gold2.png" />
      <img id="tile4" src="Platina.png" />
      <img id="tile5" src="Silver.png" />
      <img id="pick0" src="Bronze_pick.png" />
      <img id="pick1" src="Bronze2_pick.png" />
      <img id="pick2" src="Gold_pick.png" />
      <img id="pick3" src="Gold2_pick.png" />
      <img id="pick4" src="Platina_pick.png" />
      <img id="pick5" src="Silver_pick.png" />
      <img id="bg" src="Background2.png" />
    </div>

    <!-- Логика -->
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const menu = document.getElementById("menu");
        const startBtn = document.getElementById("startBtn");
        const hud = document.getElementById("hud");
        const scoreEl = document.getElementById("score");
        const movesEl = document.getElementById("moves");
        const goalEl = document.getElementById("goal");
        const canvas = document.getElementById("gameCanvas");
        const ctx = canvas.getContext("2d");

        const COLS = 7, ROWS = 10, TILE = 64;
        let board = [], selected = null;
        let score = 0, moves = 20, goalCount = 0, GOAL = 15;

        const tileImages = [], pickImages = [];
        for (let i = 0; i < 6; i++) {
          tileImages.push(document.getElementById("tile" + i));
          pickImages.push(document.getElementById("pick" + i));
        }
        const bgImage = document.getElementById("bg");

        startBtn.onclick = () => {
          menu.remove();
          hud.style.display = "flex";
          initBoard();
        };

        function initBoard() {
          score = 0; moves = 20; goalCount = 0;
          do {
            board = Array.from({ length: ROWS }, () =>
              Array.from({ length: COLS }, () =>
                Math.floor(Math.random() * tileImages.length)
              )
            );
          } while (findMatches().length);
          updateHUD();
          draw();
        }

        function updateHUD() {
          scoreEl.textContent = `Счёт: ${score}`;
          movesEl.textContent = `Ходов: ${moves}`;
          goalEl.textContent = `Gold2: ${goalCount}/${GOAL}`;
        }

        function draw() {
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          ctx.drawImage(bgImage, 0, 0, canvas.width, canvas.height);
          for (let y = 0; y < ROWS; y++) {
            for (let x = 0; x < COLS; x++) {
              const idx = board[y][x];
              if (idx == null) continue;
              const img = selected && selected.x === x && selected.y === y
                ? pickImages[idx]
                : tileImages[idx];
              ctx.drawImage(img, x * TILE, y * TILE, TILE, TILE);
            }
          }
        }

        function getTileFromEvent(e) {
          const rect = canvas.getBoundingClientRect();
          const clientX = e.touches ? e.touches[0].clientX : e.clientX;
          const clientY = e.touches ? e.touches[0].clientY : e.clientY;
          const x = Math.floor((clientX - rect.left) / TILE);
          const y = Math.floor((clientY - rect.top) / TILE);
          return { x, y };
        }

        function handleInput(e) {
          e.preventDefault();
          if (moves <= 0) return;
          const { x, y } = getTileFromEvent(e);
          if (x < 0 || x >= COLS || y < 0 || y >= ROWS) return;

          if (selected) {
            const dx = Math.abs(selected.x - x),
                  dy = Math.abs(selected.y - y);
            if (dx + dy === 1) {
              swap(selected.x, selected.y, x, y);
              const m = findMatches();
              if (m.length) {
                moves--;
                processMatches(m);
              } else {
                swap(selected.x, selected.y, x, y);
              }
              selected = null;
            } else {
              selected = { x, y };
            }
          } else {
            selected = { x, y };
          }

          updateHUD();
          draw();
          checkEnd();
        }

        canvas.addEventListener("click", handleInput);
        canvas.addEventListener("touchstart", handleInput, { passive: false });

        function swap(x1, y1, x2, y2) {
          [board[y1][x1], board[y2][x2]] = [board[y2][x2], board[y1][x1]];
        }

        function findMatches() {
          const set = new Set();
          for (let y = 0; y < ROWS; y++) {
            for (let x = 0; x < COLS - 2; x++) {
              const t = board[y][x];
              if (t != null && t === board[y][x+1] && t === board[y][x+2]) {
                [[x,y],[x+1,y],[x+2,y]].forEach(p => set.add(JSON.stringify(p)));
              }
            }
          }
          for (let x = 0; x < COLS; x++) {
            for (let y = 0; y < ROWS - 2; y++) {
              const t = board[y][x];
              if (t != null && t === board[y+1][x] && t === board[y+2][x]) {
                [[x,y],[x,y+1],[x,y+2]].forEach(p => set.add(JSON.stringify(p)));
              }
            }
          }
          return Array.from(set).map(JSON.parse);
        }

        function processMatches(matches) {
          matches.forEach(([x, y]) => {
            if (board[y][x] === 3) goalCount++;
            board[y][x] = null;
            score += 10;
          });
          collapse();
          refill();
          updateHUD();
          draw();
          setTimeout(() => {
            const nxt = findMatches();
            if (nxt.length) processMatches(nxt);
          }, 200);
        }

        function collapse() {
          for (let x = 0; x < COLS; x++) {
            const col = board.map(r => r[x]).filter(v => v != null);
            while (col.length < ROWS) {
              col.unshift(Math.floor(Math.random() * tileImages.length));
            }
            for (let y = 0; y < ROWS; y++) {
              board[y][x] = col[y];
            }
          }
        }

        function refill() {
          for (let y = 0; y < ROWS; y++) {
            for (let x = 0; x < COLS; x++) {
              if (board[y][x] == null) {
                board[y][x] = Math.floor(Math.random() * tileImages.length);
              }
            }
          }
        }

        function checkEnd() {
          if (goalCount >= GOAL) showEnd("Победа!");
          else if (moves <= 0) showEnd("Игра окончена");
        }

        function showEnd(text) {
          const overlay = document.createElement("div");
          Object.assign(overlay.style, {
            position: "fixed", inset: "0",
            display: "flex", justifyContent: "center",
            alignItems: "center",
            background: "rgba(0,0,0,0.8)", zIndex: 200
          });
          overlay.innerHTML = `
            <div style="background:#000a;padding:30px;border-radius:8px;text-align:center;">
              <h2 style="color:#fff;margin-bottom:20px;">${text}</h2>
              <button id="restartBtn" style="font-size:18px;padding:10px 20px;border:none;border-radius:4px;background:#fff;color:#000;cursor:pointer;">Начать заново</button>
            </div>`;
          document.body.appendChild(overlay);
          document.getElementById("restartBtn").onclick = () => { overlay.remove(); initBoard(); };
        }
      });
    </script>
  </body>
</html>
